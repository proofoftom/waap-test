(function(c,s,l){"use strict";var u=!1;s.behaviors.walletAuth={connector:null,state:"idle",attach:function(t,n){!u&&c(t).is(document)&&(u=!0,this.init(t,n))},init:function(t,n){var e=this,o=c,a=n.walletAuth||{};this.connector=new WalletAuthConnector({authenticationMethods:a.authenticationMethods||["email","social"],allowedSocials:a.allowedSocials||["google","twitter","discord"]});var r=o(".wallet-auth-login-btn",t);r.on("click",function(i){i.preventDefault(),e.handleLogin()});var h=o(".wallet-auth-disconnect-btn",t);h.on("click",function(i){i.preventDefault(),e.handleDisconnect()}),this.connector.init().then(function(){return e.connector.checkSession()}).then(function(i){i?(e.setState("connected"),e.updateUI(),e.authenticate(i)):(e.setState("idle"),e.updateUI())}).catch(function(i){console.error("Initialization error:",i),e.setState("error"),e.showError(i.message)}),this.connector.on("disconnect",function(){e.setState("idle"),e.updateUI()}),this.connector.on("accountChanged",function(i){i.length>0?e.authenticate(i[0]):(e.setState("idle"),e.updateUI())})},handleLogin:function(){var t=this;this.setState("connecting"),this.connector.login().then(function(n){if(!n){t.setState("idle");return}console.log("Logged in via:",n),t.setState("connected");var e=t.connector.getAddress();t.authenticate(e)}).catch(function(n){console.error("Login error:",n),t.setState("error"),t.showError(n.message)})},handleDisconnect:function(){this.connector.logout(),this.setState("idle"),this.updateUI()},authenticate:function(t){var n=this;this.setState("signing"),this.updateUI(),this.fetchNonce(t).then(function(e){var o=e.nonce;n.connector.lastNonce=o;var a=n.createSignMessage(t,o);return n.connector.signMessage(a)}).then(function(e){return n.sendAuthentication(t,e)}).then(function(e){if(e.success)n.setState("authenticated"),n.showSuccess("Logged in as "+e.username),l.walletAuth.redirectOnSuccess?window.location.href=l.walletAuth.redirectOnSuccess:window.location.reload();else throw new Error(e.error||"Authentication failed")}).catch(function(e){console.error("Authentication error:",e),n.setState("error"),n.showError(e.message||"Authentication failed")})},fetchNonce:function(t){var n=l.walletAuth.apiEndpoint;return fetch(n+"/nonce?wallet_address="+t,{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json"}}).then(function(e){if(!e.ok)throw new Error("Failed to fetch nonce");return e.json()})},createSignMessage:function(t,n){return"Sign this message to prove ownership of "+t+`.

Nonce: `+n},sendAuthentication:function(t,n){var e=l.walletAuth.apiEndpoint,o=this.connector.lastNonce,a=this.createSignMessage(t,o);return fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({wallet_address:t,signature:n,message:a,nonce:o})}).then(function(r){return r.ok?r.json():r.json().then(function(h){throw new Error(h.error||"Authentication failed")})})},setState:function(t){this.state=t,c("body").attr("data-wallet-auth-state",t)},updateUI:function(){var t=c;t(".wallet-auth-container");var n=t(".wallet-auth-login-btn"),e=t(".wallet-auth-disconnect-btn"),o=t(".wallet-auth-status");switch(n.addClass("visually-hidden"),e.addClass("visually-hidden"),this.state){case"idle":n.removeClass("visually-hidden"),o.text("Connect your wallet to login");break;case"connecting":n.removeClass("visually-hidden").prop("disabled",!0),o.text("Connecting to wallet...");break;case"connected":e.removeClass("visually-hidden"),o.text("Connected: "+this.formatAddress(this.connector.getAddress()));break;case"signing":o.text("Please sign the message in your wallet...");break;case"authenticated":o.text("Authentication successful!");break;case"error":n.removeClass("visually-hidden").prop("disabled",!1),o.text("Authentication failed. Please try again.");break}},showError:function(t){s.behaviors.walletAuth.showMessage?s.behaviors.walletAuth.showMessage(t,"error"):alert(t)},showSuccess:function(t){s.behaviors.walletAuth.showMessage?s.behaviors.walletAuth.showMessage(t,"status"):console.log(t)},formatAddress:function(t){return t?t.substring(0,6)+"..."+t.substring(t.length-4):""},detach:function(t,n){this.connector&&this.connector.destroy()}},s.behaviors.walletAuth.showMessage=function(t,n){n=typeof n<"u"?n:"status";var e=c,o=e(".messages__wrapper");if(o.length){var a=e('<div class="messages messages--'+n+'">'+t+"</div>");o.append(a),setTimeout(function(){a.fadeOut()},5e3)}}})(jQuery,Drupal,drupalSettings);
