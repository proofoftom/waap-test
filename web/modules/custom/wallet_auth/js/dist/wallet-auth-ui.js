(function(l,c,u){"use strict";var h=!1;c.behaviors.walletAuth={connector:null,state:"idle",csrfToken:null,buttonText:"Sign In",displayMode:"link",attach:function(e,t){!h&&l(e).is(document)&&(h=!0,this.init(e,t))},init:function(e,t){var n=this,a=l,i=t.walletAuth||{},o=i.waapConfig||{};o.projectName=i.projectName||"",o.projectLogo=i.projectLogo||"",o.projectEntryTitle=i.projectEntryTitle||"",o.walletConnectProjectId=i.walletConnectProjectId||"",this.connector=new c.walletAuth.WalletConnector(o),this.buttonText=i.buttonText||"Sign In",this.displayMode=i.displayMode||"link";var r=a(".wallet-auth-trigger",e);this.displayMode==="button"&&r.addClass("button button--primary button--small"),r.on("click",function(s){s.preventDefault(),n.handleSignIn()}),this.connector.init().then(function(){n.setState("idle"),n.updateUI()}).catch(function(s){console.error("Initialization error:",s),n.setState("error"),n.showError("Failed to initialize wallet connection")})},handleSignIn:function(){var e=this;this.setState("signing"),this.updateUI(),this.connector.checkSession().then(function(t){return t?(console.log("Using existing wallet session:",t),t):e.connector.login().then(function(n){if(!n)throw{cancelled:!0};return console.log("Logged in via:",n),e.connector.getAddress()})}).then(function(t){return e.performAuthentication(t)}).catch(function(t){if(t&&t.cancelled){e.setState("idle"),e.updateUI();return}console.error("Sign-in error:",t),t.message&&t.message.includes("User rejected")||t.message&&t.message.includes("user rejected")||t.code===4001?(e.setState("idle"),e.updateUI(),e.showError("Signature request was cancelled. Please try again.")):(e.setState("error"),e.updateUI(),e.showError(t.message||"Sign-in failed"))})},performAuthentication:function(e){var t=this;return this.fetchNonce(e).then(function(n){var a=n.nonce;t.connector.lastNonce=a,t.csrfToken=n.csrf_token;var i=t.createSignMessage(e,a);return t.connector.signMessage(i).then(function(o){return{signature:o,message:i,nonce:a}})}).then(function(n){return t.sendAuthentication(e,n.signature,n.message,n.nonce)}).then(function(n){if(n.success)t.setState("authenticated"),t.showSuccess("Signed in as "+n.username),u.walletAuth.redirectOnSuccess?window.location.href=u.walletAuth.redirectOnSuccess:window.location.reload();else throw new Error(n.error||"Authentication failed")})},fetchNonce:function(e){var t=u.walletAuth.apiEndpoint;return fetch(t+"/nonce?wallet_address="+e,{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json"}}).then(function(n){if(!n.ok)throw new Error("Failed to fetch nonce");return n.json()})},createSignMessage:function(e,t){var n=window.location.hostname,a=window.location.origin,i=new Date().toISOString(),o=new Date(Date.now()+3e5).toISOString(),r=u.walletAuth.chainId||1,s=n+` wants you to sign in with your Ethereum account:
`;return s+=e+`

`,s+=`Sign in with Ethereum to prove ownership of your wallet.

`,s+="URI: "+a+`
`,s+=`Version: 1
`,s+="Chain ID: "+r+`
`,s+="Nonce: "+t+`
`,s+="Issued At: "+i+`
`,s+="Expiration Time: "+o,s},sendAuthentication:function(e,t,n,a){var i=u.walletAuth.apiEndpoint+"/authenticate";return fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({wallet_address:e,signature:t,message:n,nonce:a,csrf_token:this.csrfToken})}).then(function(o){return o.ok?o.json():o.json().then(function(r){throw new Error(r.error||"Authentication failed")})})},setState:function(e){this.state=e,l("body").attr("data-wallet-auth-state",e)},updateUI:function(){var e=l,t=e(".wallet-auth-trigger"),n=e(".wallet-auth-status"),a=e(".wallet-auth-container"),i=function(o,r){var s=o.find("span");s.length?s.text(r):o.text(r)};switch(this.state){case"idle":t.removeClass("is-disabled"),i(t,this.buttonText),a.length&&a.attr("data-wallet-auth-state","idle"),n.length&&n.text("");break;case"signing":t.addClass("is-disabled"),i(t,"Signing in..."),a.length&&a.attr("data-wallet-auth-state","signing"),n.length&&n.text("Please complete the sign-in in your wallet...");break;case"authenticated":t.addClass("is-disabled"),i(t,"Signed In"),a.length&&a.attr("data-wallet-auth-state","authenticated"),n.length&&n.text("Authentication successful!");break;case"error":t.removeClass("is-disabled"),i(t,"Try Again"),a.length&&a.attr("data-wallet-auth-state","error"),n.length&&n.text("Sign-in failed. Please try again.");break}},showError:function(e){c.behaviors.walletAuth.showMessage?c.behaviors.walletAuth.showMessage(e,"error"):alert(e)},showSuccess:function(e){c.behaviors.walletAuth.showMessage?c.behaviors.walletAuth.showMessage(e,"status"):console.log(e)},formatAddress:function(e){return e?e.substring(0,6)+"..."+e.substring(e.length-4):""},detach:function(e,t){this.connector&&this.connector.destroy()}},c.behaviors.walletAuth.showMessage=function(e,t){t=typeof t<"u"?t:"status";var n=l,a=n(".messages__wrapper");if(a.length){var i=n('<div class="messages messages--'+t+'">'+e+"</div>");a.append(i),setTimeout(function(){i.fadeOut()},5e3)}}})(jQuery,Drupal,drupalSettings);
