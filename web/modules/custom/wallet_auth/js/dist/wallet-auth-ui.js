(function(r,c,l){"use strict";var h=!1;c.behaviors.walletAuth={connector:null,state:"idle",csrfToken:null,attach:function(t,n){!h&&r(t).is(document)&&(h=!0,this.init(t,n))},init:function(t,n){var e=this,i=r,a=n.walletAuth||{};this.connector=new c.walletAuth.WalletConnector({authenticationMethods:a.authenticationMethods||["email","social"],allowedSocials:a.allowedSocials||["google","twitter","discord"]});var s=i(".wallet-auth-login-btn",t);s.on("click",function(o){o.preventDefault(),e.handleLogin()});var u=i(".wallet-auth-disconnect-btn",t);u.on("click",function(o){o.preventDefault(),e.handleDisconnect()}),this.connector.init().then(function(){return e.connector.checkSession()}).then(function(o){o?(e.setState("connected"),e.updateUI()):(e.setState("idle"),e.updateUI())}).catch(function(o){console.error("Initialization error:",o),e.setState("error"),e.showError(o.message)}),this.connector.on("disconnect",function(){e.setState("idle"),e.updateUI()}),this.connector.on("accountChanged",function(o){o.length>0?(e.setState("connected"),e.updateUI()):(e.setState("idle"),e.updateUI())})},handleLogin:function(){var t=this,n=this.connector.getAddress();if(n){console.log("Already connected to WaaP, proceeding to authentication"),this.authenticate(n);return}this.setState("connecting"),this.connector.login().then(function(e){if(!e){t.setState("idle");return}console.log("Logged in via:",e),t.setState("connected");var i=t.connector.getAddress();t.authenticate(i)}).catch(function(e){console.error("Login error:",e),t.setState("error"),t.showError(e.message)})},handleDisconnect:function(){this.connector.logout(),this.setState("idle"),this.updateUI()},authenticate:function(t){var n=this;this.setState("signing"),this.updateUI(),this.fetchNonce(t).then(function(e){var i=e.nonce;n.connector.lastNonce=i,n.csrfToken=e.csrf_token;var a=n.createSignMessage(t,i);return n.connector.signMessage(a).then(function(s){return{signature:s,message:a,nonce:i}})}).then(function(e){return n.sendAuthentication(t,e.signature,e.message,e.nonce)}).then(function(e){if(e.success)n.setState("authenticated"),n.showSuccess("Logged in as "+e.username),l.walletAuth.redirectOnSuccess?window.location.href=l.walletAuth.redirectOnSuccess:window.location.reload();else throw new Error(e.error||"Authentication failed")}).catch(function(e){console.error("Authentication error:",e),e.message&&e.message.includes("User rejected")||e.message&&e.message.includes("user rejected")||e.code===4001?(n.setState("connected"),n.updateUI(),n.showError("Signature request was cancelled. Please try again.")):(n.setState("error"),n.updateUI(),n.showError(e.message||"Authentication failed"))})},fetchNonce:function(t){var n=l.walletAuth.apiEndpoint;return fetch(n+"/nonce?wallet_address="+t,{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json"}}).then(function(e){if(!e.ok)throw new Error("Failed to fetch nonce");return e.json()})},createSignMessage:function(t,n){var e=window.location.hostname,i=window.location.origin,a=new Date().toISOString(),s=new Date(Date.now()+3e5).toISOString(),u=l.walletAuth.chainId||1,o=e+` wants you to sign in with your Ethereum account:
`;return o+=t+`

`,o+=`Sign in with Ethereum to prove ownership of your wallet.

`,o+="URI: "+i+`
`,o+=`Version: 1
`,o+="Chain ID: "+u+`
`,o+="Nonce: "+n+`
`,o+="Issued At: "+a+`
`,o+="Expiration Time: "+s,o},sendAuthentication:function(t,n,e,i){var a=l.walletAuth.apiEndpoint+"/authenticate";return fetch(a,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({wallet_address:t,signature:n,message:e,nonce:i,csrf_token:this.csrfToken})}).then(function(s){return s.ok?s.json():s.json().then(function(u){throw new Error(u.error||"Authentication failed")})})},setState:function(t){this.state=t,r("body").attr("data-wallet-auth-state",t)},updateUI:function(){var t=r;t(".wallet-auth-container");var n=t(".wallet-auth-login-btn"),e=t(".wallet-auth-disconnect-btn"),i=t(".wallet-auth-status");switch(n.addClass("visually-hidden"),e.addClass("visually-hidden"),this.state){case"idle":n.removeClass("visually-hidden").find("span").text("Connect Wallet"),i.text("Connect your wallet to login");break;case"connecting":n.removeClass("visually-hidden").prop("disabled",!0).find("span").text("Connecting..."),i.text("Connecting to wallet...");break;case"connected":n.removeClass("visually-hidden").prop("disabled",!1).find("span").text("Sign in"),e.removeClass("visually-hidden"),i.text("Connected: "+this.formatAddress(this.connector.getAddress()));break;case"signing":n.removeClass("visually-hidden").prop("disabled",!0).find("span").text("Signing..."),i.text("Please sign the message in your wallet...");break;case"authenticated":i.text("Authentication successful!");break;case"error":n.removeClass("visually-hidden").prop("disabled",!1).find("span").text("Try Again"),i.text("Authentication failed. Please try again.");break}},showError:function(t){c.behaviors.walletAuth.showMessage?c.behaviors.walletAuth.showMessage(t,"error"):alert(t)},showSuccess:function(t){c.behaviors.walletAuth.showMessage?c.behaviors.walletAuth.showMessage(t,"status"):console.log(t)},formatAddress:function(t){return t?t.substring(0,6)+"..."+t.substring(t.length-4):""},detach:function(t,n){this.connector&&this.connector.destroy()}},c.behaviors.walletAuth.showMessage=function(t,n){n=typeof n<"u"?n:"status";var e=r,i=e(".messages__wrapper");if(i.length){var a=e('<div class="messages messages--'+n+'">'+t+"</div>");i.append(a),setTimeout(function(){a.fadeOut()},5e3)}}})(jQuery,Drupal,drupalSettings);
